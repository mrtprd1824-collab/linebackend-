<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>{% block title %}Line Backend{% endblock %}</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192x192.png') }}">
    <meta name="theme-color" content="#1EE494">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat_style.css') }}">

    {% block extra_css %}{% endblock %}

    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 56px;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, .04);
        }
    </style>
</head>

<body>
    {# --- 1. Navbar --- #}
    {% if current_user.is_authenticated %}
    <nav class="navbar navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <button class="navbar-toggler me-2" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/">Line Backend</a>
            {% if inactive_oa_count > 0 %}
            <div class="ms-auto">
                <a href="{{ url_for('admin.oa_health_check_page') }}" class="btn btn-danger position-relative"
                    title="มี OA ที่เชื่อมต่อไม่ได้!">
                    <i class="bi bi-wifi-off"></i>
                    <span
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                        {{ inactive_oa_count }}
                        <span class="visually-hidden">inactive accounts</span>
                    </span>
                </a>
            </div>
            {% endif %}
            <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel" style="width: 250px;">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Line Backend</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav flex-column">
                        <li class="nav-item">
                            <div class="nav-link text-white d-flex justify-content-between align-items-center">

                                <label for="theme-switch-checkbox" style="cursor: pointer;">
                                    <i class="bi bi-toggles me-2"></i>
                                    Light - Dark
                                </label>

                                <label class="switch">
                                    <span class="sun"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <g fill="#ffd43b">
                                                <circle r="5" cy="12" cx="12"></circle>
                                                <path
                                                    d="m21 13h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm-17 0h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm13.66-5.66a1 1 0 0 1 -.66-.29 1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1 -.75.29zm-12.02 12.02a1 1 0 0 1 -.71-.29 1 1 0 0 1 0-1.41l.71-.66a1 1 0 0 1 1.41 1.41l-.71.71a1 1 0 0 1 -.7.24zm6.36-14.36a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm0 17a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm-5.66-14.66a1 1 0 0 1 -.7-.29l-.71-.71a1 1 0 0 1 1.41-1.41l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.29zm12.02 12.02a1 1 0 0 1 -.7-.29l-.66-.71a1 1 0 0 1 1.36-1.36l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.24z">
                                                </path>
                                            </g>
                                        </svg></span>
                                    <span class="moon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                            <path
                                                d="m223.5 32c-123.5 0-223.5 100.3-223.5 224s100 224 223.5 224c60.6 0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9 0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z">
                                            </path>
                                        </svg></span>
                                    <input type="checkbox" class="input" id="theme-switch-checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="enable-notifications-btn">
                                <i class="bi bi-bell-fill me-2"></i>เปิดแจ้งเตือน Desktop
                            </a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('changelog_bp.index') }}"><i
                                    class="bi bi-megaphone-fill me-2"></i>บันทึกการเปลี่ยนแปลง</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.dashboard') }}"><i
                                    class="bi bi-house-door-fill me-2"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('stats.index') }}"><i
                                    class="bi bi-bar-chart-fill me-2"></i>สถิติ</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.profile') }}"><i
                                    class="bi bi-person-fill me-2"></i>Profile</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.oa_health_check_page') }}"><i
                                    class="bi bi-heart-pulse-fill me-2"></i>OA Health Check</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        {% if current_user.is_admin %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('tags.manage_tags_page') }}"><i
                                    class="bi bi-tags-fill me-2"></i>Manage Tags</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('search.search_page') }}"><i
                                    class="bi bi-search me-2"></i>Search Users</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('line_admin.line_admin_index') }}"><i
                                    class="bi bi-link-45deg me-2"></i>Line OA</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('quick_replies.index') }}"><i
                                    class="bi bi-lightning-charge-fill me-2"></i>Quick Replies</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('oa_groups.index') }}"><i
                                    class="bi bi-folder-fill me-2"></i>OA Groups</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.manage_users') }}"><i
                                    class="bi bi-people-fill me-2"></i>Manage Users</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        {% endif %}
                        <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('auth.logout') }}"><i
                                    class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">

        {# 2. วนลูปแสดง Flash Messages ในรูปแบบของ Toast #}
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">

                {#-- เพิ่มไอคอนตามประเภทการแจ้งเตือน --#}
                {% if category == 'success' %}
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                {% elif category == 'warning' %}
                <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                {% elif category == 'danger' %}
                <i class="bi bi-x-octagon-fill text-danger me-2"></i>
                {% else %}
                <i class="bi bi-info-circle-fill text-info me-2"></i>
                {% endif %}

                <strong class="me-auto">Notification</strong>
                <small>just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                {{ message }}
            </div>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

    </div>

    <main>
        {# ส่วนแสดง Flash Messages ต้องอยู่ข้างนอก Block Content #}

        {# ★★★ นี่คือ Block Content เพียงหนึ่งเดียว ที่ถูกต้อง ★★★ #}
        {% block content %}{% endblock %}
    </main>

    {# --- 3. Scripts --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeSwitch = document.getElementById('theme-switch-checkbox');
            const htmlElement = document.documentElement;

            const setTheme = (theme) => {
                htmlElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
                themeSwitch.checked = theme === 'dark';
            };

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme) {
                setTheme(savedTheme);
            } else if (prefersDark) {
                setTheme('dark');
            } else {
                setTheme('light');
            }

            themeSwitch.addEventListener('change', () => {
                setTheme(themeSwitch.checked ? 'dark' : 'light');
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 1. ค้นหา Toast ทั้งหมดที่มีในหน้าเว็บ
            const toastElList = document.querySelectorAll('.toast');

            // 2. วนลูปเพื่อสร้าง instance ของ Toast จาก Bootstrap
            const toastList = [...toastElList].map(toastEl => {
                const toast = new bootstrap.Toast(toastEl, {
                    delay: 5000 // ให้ Toast หายไปเองใน 5 วินาที (ปรับค่าได้)
                });

                // 3. สั่งให้ Toast แสดงผล
                toast.show();
            });
        });
    </script>

    {% block scripts %}{% endblock %}

</body>

</html>
