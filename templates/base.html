<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>{% block title %}Line Backend{% endblock %}</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192x192.png') }}">
    <meta name="theme-color" content="#1EE494">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat_style.css') }}">

    {% block extra_css %}{% endblock %}

    <style>
        :root {
            --app-navbar-height: 72px;
            --app-accent: #5f58ff;
            --app-surface: rgba(255, 255, 255, 0.78);
            --app-border: rgba(99, 110, 139, 0.16);
        }

        @media (max-width: 991.98px) {
            :root {
                --app-navbar-height: 64px;
            }
        }

        body {
            margin: 0;
            min-height: 100vh;
            --app-navbar-offset: 0px;
            padding-top: var(--app-navbar-offset);
            background: linear-gradient(135deg, #eef2ff, #f8fafc);
            color: #0f172a;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.has-navbar {
            --app-navbar-offset: var(--app-navbar-height);
        }

        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-navbar {
            backdrop-filter: blur(14px);
            background: var(--app-surface);
            border-bottom: 1px solid var(--app-border);
        }

        .app-navbar .container-fluid {
            gap: 1rem;
        }

        .app-navbar .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.03em;
            color: inherit;
        }

        .brand-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(95, 88, 255, 0.12);
            color: var(--app-accent);
            box-shadow: inset 0 0 0 1px rgba(95, 88, 255, 0.1);
        }

        .app-navbar .navbar-nav .nav-link {
            border-radius: 12px;
            padding: 0.45rem 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            transition: color 0.2s ease, background 0.2s ease;
        }

        .app-navbar .navbar-nav .nav-link:hover,
        .app-navbar .navbar-nav .nav-link:focus {
            color: var(--app-accent);
            background: rgba(95, 88, 255, 0.12);
        }

        .app-icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid rgba(99, 110, 139, 0.24);
            background: rgba(255, 255, 255, 0.55);
            color: inherit;
            position: relative;
            transition: all 0.2s ease;
        }

        .app-icon-btn:hover,
        .app-icon-btn:focus {
            border-color: rgba(95, 88, 255, 0.4);
            color: var(--app-accent);
            box-shadow: 0 12px 28px rgba(95, 88, 255, 0.12);
        }

        .app-icon-btn.badge-alert {
            background: rgba(220, 53, 69, 0.12);
            border-color: rgba(220, 53, 69, 0.28);
            color: #dc3545;
        }

        .app-icon-btn.badge-alert:hover,
        .app-icon-btn.badge-alert:focus {
            background: rgba(220, 53, 69, 0.18);
        }

        .app-icon-btn.badge-alert .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            border-radius: 999px;
            padding: 0.2rem 0.45rem;
            font-size: 0.7rem;
        }

        .theme-toggle .switch {
            margin-left: 0;
        }

        .dropdown-menu.app-dropdown {
            border-radius: 16px;
            border: 1px solid var(--app-border);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            padding: 0.4rem;
        }

        .dropdown-menu.app-dropdown .dropdown-item {
            border-radius: 10px;
            font-weight: 500;
        }

        .dropdown-menu.app-dropdown .dropdown-item:hover,
        .dropdown-menu.app-dropdown .dropdown-item:focus {
            background: rgba(95, 88, 255, 0.12);
            color: var(--app-accent);
        }

        .app-nav-drawer {
            width: 280px;
            background: rgba(255, 255, 255, 0.96);
            border-right: 1px solid var(--app-border);
            color: inherit;
        }

        .app-nav-drawer .offcanvas-header {
            border-bottom: 1px solid var(--app-border);
        }

        .app-nav-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .app-nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 700;
            color: rgba(15, 23, 42, 0.55);
            margin-bottom: 0.25rem;
        }

        .app-nav-drawer .nav.flex-column .nav-link {
            border-radius: 12px;
            padding: 0.65rem 0.85rem;
            font-weight: 500;
        }

        .app-nav-drawer .nav.flex-column .nav-link:hover,
        .app-nav-drawer .nav.flex-column .nav-link:focus {
            background: rgba(95, 88, 255, 0.12);
            color: var(--app-accent);
        }

        .app-toast {
            border-radius: 16px;
            border: 1px solid var(--app-border);
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
            overflow: hidden;
        }

        .app-toast .toast-header {
            border-bottom: 1px solid rgba(99, 110, 139, 0.14);
            background: transparent;
        }

        .app-content {
            flex: 1;
            width: 100%;
        }

        [data-bs-theme="dark"] body {
            background: linear-gradient(135deg, #0f172a, #020617);
            color: #e2e8f0;
        }

        [data-bs-theme="dark"] .app-navbar {
            background: rgba(15, 23, 42, 0.82);
            border-color: rgba(148, 163, 184, 0.22);
        }

        [data-bs-theme="dark"] .brand-badge {
            background: rgba(95, 88, 255, 0.18);
            color: #8b93ff;
            box-shadow: inset 0 0 0 1px rgba(139, 147, 255, 0.3);
        }

        [data-bs-theme="dark"] .app-icon-btn {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(148, 163, 184, 0.24);
        }

        [data-bs-theme="dark"] .app-icon-btn:hover,
        [data-bs-theme="dark"] .app-icon-btn:focus {
            border-color: rgba(139, 147, 255, 0.4);
            color: #8b93ff;
        }

        [data-bs-theme="dark"] .app-nav-drawer {
            background: rgba(15, 23, 42, 0.95);
            border-color: rgba(148, 163, 184, 0.2);
        }

        [data-bs-theme="dark"] .app-nav-drawer .offcanvas-header {
            border-color: rgba(148, 163, 184, 0.2);
        }

        [data-bs-theme="dark"] .app-nav-section-title {
            color: rgba(226, 232, 240, 0.6);
        }

        [data-bs-theme="dark"] .app-nav-drawer .nav.flex-column .nav-link:hover,
        [data-bs-theme="dark"] .app-nav-drawer .nav.flex-column .nav-link:focus {
            background: rgba(139, 147, 255, 0.18);
            color: #8b93ff;
        }

        [data-bs-theme="dark"] .dropdown-menu.app-dropdown {
            background: rgba(17, 24, 39, 0.95);
            border-color: rgba(148, 163, 184, 0.2);
        }

        [data-bs-theme="dark"] .app-toast {
            background: rgba(17, 24, 39, 0.92);
            border-color: rgba(148, 163, 184, 0.24);
            color: #e2e8f0;
        }

        [data-bs-theme="dark"] .app-toast .toast-header {
            border-color: rgba(148, 163, 184, 0.16);
        }
    </style>
</head>

{% set body_class_list = [] %}
{% if current_user.is_authenticated %}
    {% set body_class_list = body_class_list + ['has-navbar'] %}
{% endif %}
{% if page_type %}
    {% set body_class_list = body_class_list + ['page-' ~ page_type] %}
{% endif %}
<body{% if body_class_list %} class="{{ ' '.join(body_class_list) }}"{% endif %}>
    <div class="app-shell">
        {% if current_user.is_authenticated %}
        {% set common_links = [
            {"endpoint": "changelog_bp.index", "icon": "bi-megaphone-fill", "label": "บันทึกการเปลี่ยนแปลง"},
            {"endpoint": "auth.dashboard", "icon": "bi-house-door-fill", "label": "Dashboard"},
            {"endpoint": "stats.index", "icon": "bi-bar-chart-fill", "label": "สถิติ"},
            {"endpoint": "auth.profile", "icon": "bi-person-fill", "label": "Profile"},
            {"endpoint": "admin.oa_health_check_page", "icon": "bi-heart-pulse-fill", "label": "OA Health Check"}
        ] %}
        {% set admin_links = [
            {"endpoint": "tags.manage_tags_page", "icon": "bi-tags-fill", "label": "Manage Tags"},
            {"endpoint": "search.search_page", "icon": "bi-search", "label": "Search Users"},
            {"endpoint": "line_admin.line_admin_index", "icon": "bi-link-45deg", "label": "Line OA"},
            {"endpoint": "quick_replies.index", "icon": "bi-lightning-charge-fill", "label": "Quick Replies"},
            {"endpoint": "oa_groups.index", "icon": "bi-folder-fill", "label": "OA Groups"},
            {"endpoint": "admin.manage_users", "icon": "bi-people-fill", "label": "Manage Users"}
        ] %}
        <nav class="navbar navbar-expand-lg app-navbar fixed-top">
            <div class="container-fluid py-2 px-3 px-lg-4">
                <div class="d-flex align-items-center gap-2">
                    <button class="app-icon-btn d-lg-none" type="button" data-bs-toggle="offcanvas"
                        data-bs-target="#appNavDrawer" aria-controls="appNavDrawer" aria-label="เปิดเมนู">
                        <i class="bi bi-list"></i>
                    </button>
                    <a class="navbar-brand d-flex align-items-center gap-2" href="/">
                        <span class="brand-badge">
                            <i class="bi bi-chat-dots-fill"></i>
                        </span>
                        <span>Line Backend</span>
                    </a>
                </div>
                <div class="d-none d-lg-flex align-items-center flex-grow-1 ms-4">
                    <ul class="navbar-nav align-items-center gap-1 flex-wrap">
                        {% for item in common_links %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for(item.endpoint) }}">
                                <i class="bi {{ item.icon }}"></i>
                                <span>{{ item.label }}</span>
                            </a>
                        </li>
                        {% endfor %}
                        {% if current_user.is_admin %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="adminMenu" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-sliders"></i>
                                <span>Admin</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end app-dropdown" aria-labelledby="adminMenu">
                                {% for item in admin_links %}
                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                        href="{{ url_for(item.endpoint) }}">
                                        <i class="bi {{ item.icon }}"></i>
                                        <span>{{ item.label }}</span>
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <a class="app-icon-btn" href="#" id="enable-notifications-btn" title="เปิดแจ้งเตือน Desktop">
                        <i class="bi bi-bell-fill"></i>
                    </a>
                    {% if inactive_oa_count > 0 %}
                    <a href="{{ url_for('admin.oa_health_check_page') }}" class="app-icon-btn badge-alert"
                        title="มี OA ที่เชื่อมต่อไม่ได้!">
                        <i class="bi bi-wifi-off"></i>
                        <span class="badge bg-danger text-white">{{ inactive_oa_count }}</span>
                    </a>
                    {% endif %}
                    <div class="theme-toggle d-none d-md-flex align-items-center gap-2">
                        <span class="fw-semibold small text-muted">Theme</span>
                        <label class="switch mb-0" title="สลับโหมดแสง/มืด">
                            <span class="sun"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <g fill="#ffd43b">
                                        <circle r="5" cy="12" cx="12"></circle>
                                        <path
                                            d="m21 13h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm-17 0h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm13.66-5.66a1 1 0 0 1 -.66-.29 1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1 -.75.29zm-12.02 12.02a1 1 0 0 1 -.71-.29 1 1 0 0 1 0-1.41l.71-.66a1 1 0 0 1 1.41 1.41l-.71.71a1 1 0 0 1 -.7.24zm6.36-14.36a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm0 17a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm-5.66-14.66a1 1 0 0 1 -.7-.29l-.71-.71a1 1 0 0 1 1.41-1.41l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.29zm12.02 12.02a1 1 0 0 1 -.7-.29l-.66-.71a1 1 0 0 1 1.36-1.36l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.24z">
                                        </path>
                                    </g>
                                </svg></span>
                            <span class="moon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                    <path
                                        d="m223.5 32c-123.5 0-223.5 100.3-223.5 224s100 224 223.5 224c60.6 0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9 0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z">
                                    </path>
                                </svg></span>
                            <input type="checkbox" class="input" data-theme-toggle>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <a class="btn btn-outline-danger rounded-pill d-none d-lg-inline-flex align-items-center gap-2 px-3"
                        href="{{ url_for('auth.logout') }}">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </nav>
        <div class="offcanvas offcanvas-start app-nav-drawer" tabindex="-1" id="appNavDrawer"
            aria-labelledby="appNavDrawerLabel">
            <div class="offcanvas-header">
                <div>
                    <h5 class="offcanvas-title mb-1" id="appNavDrawerLabel">Line Backend</h5>
                    <p class="text-muted small mb-0">จัดการ OA และแชทได้ในที่เดียว</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body d-flex flex-column gap-4">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-semibold text-muted small text-uppercase">Theme</span>
                    <label class="switch mb-0" title="สลับโหมดแสง/มืด">
                        <span class="sun"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <g fill="#ffd43b">
                                    <circle r="5" cy="12" cx="12"></circle>
                                    <path
                                        d="m21 13h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm-17 0h-1a1 1 0 0 1 0-2h1a1 1 0 0 1 0 2zm13.66-5.66a1 1 0 0 1 -.66-.29 1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1 -.75.29zm-12.02 12.02a1 1 0 0 1 -.71-.29 1 1 0 0 1 0-1.41l.71-.66a1 1 0 0 1 1.41 1.41l-.71.71a1 1 0 0 1 -.7.24zm6.36-14.36a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm0 17a1 1 0 0 1 -1-1v-1a1 1 0 0 1 2 0v1a1 1 0 0 1 -1 1zm-5.66-14.66a1 1 0 0 1 -.7-.29l-.71-.71a1 1 0 0 1 1.41-1.41l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.29zm12.02 12.02a1 1 0 0 1 -.7-.29l-.66-.71a1 1 0 0 1 1.36-1.36l.71.71a1 1 0 0 1 0 1.41 1 1 0 0 1 -.71.24z">
                                    </path>
                                </g>
                            </svg></span>
                        <span class="moon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <path
                                    d="m223.5 32c-123.5 0-223.5 100.3-223.5 224s100 224 223.5 224c60.6 0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9 0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z">
                                </path>
                            </svg></span>
                        <input type="checkbox" class="input" data-theme-toggle>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="app-nav-section">
                    <span class="app-nav-section-title">เมนูหลัก</span>
                    <div class="nav flex-column gap-1">
                        {% for item in common_links %}
                        <a class="nav-link d-flex align-items-center gap-2" href="{{ url_for(item.endpoint) }}">
                            <i class="bi {{ item.icon }}"></i>
                            <span>{{ item.label }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% if current_user.is_admin %}
                <div class="app-nav-section">
                    <span class="app-nav-section-title">เครื่องมือผู้ดูแล</span>
                    <div class="nav flex-column gap-1">
                        {% for item in admin_links %}
                        <a class="nav-link d-flex align-items-center gap-2" href="{{ url_for(item.endpoint) }}">
                            <i class="bi {{ item.icon }}"></i>
                            <span>{{ item.label }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="mt-auto pt-3 border-top border-light-subtle">
                    <a class="nav-link text-danger d-flex align-items-center gap-2" href="{{ url_for('auth.logout') }}">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="toast-container position-fixed top-0 end-0 p-3"
            style="z-index: 1100; top: calc(var(--app-navbar-offset) + 16px);">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="toast app-toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    {% if category == 'success' %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    {% elif category == 'warning' %}
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                    {% elif category == 'danger' %}
                    <i class="bi bi-x-octagon-fill text-danger me-2"></i>
                    {% else %}
                    <i class="bi bi-info-circle-fill text-info me-2"></i>
                    {% endif %}
                    <strong class="me-auto">Notification</strong>
                    <small>just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    {{ message }}
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        <main class="app-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggleInputs = document.querySelectorAll('[data-theme-toggle]');
            const htmlElement = document.documentElement;
            const navbar = document.querySelector('.app-navbar');

            const updateNavbarHeight = () => {
                if (!navbar) {
                    return;
                }
                const height = navbar.offsetHeight;
                document.documentElement.style.setProperty('--app-navbar-height', `${height}px`);
            };

            const syncThemeSwitches = (theme) => {
                themeToggleInputs.forEach((toggle) => {
                    toggle.checked = theme === 'dark';
                });
            };

            const setTheme = (theme) => {
                htmlElement.setAttribute('data-bs-theme', theme);
                htmlElement.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('theme', theme);
                syncThemeSwitches(theme);
            };

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            setTheme(initialTheme);

            themeToggleInputs.forEach((toggle) => {
                toggle.addEventListener('change', () => {
                    setTheme(toggle.checked ? 'dark' : 'light');
                });
            });

            updateNavbarHeight();
            if (window.ResizeObserver && navbar) {
                const resizeObserver = new ResizeObserver(updateNavbarHeight);
                resizeObserver.observe(navbar);
            } else {
                window.addEventListener('resize', updateNavbarHeight);
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toastElList = document.querySelectorAll('.toast');
            const toastList = [...toastElList].map((toastEl) => {
                const toast = new bootstrap.Toast(toastEl, {
                    delay: 5000
                });
                toast.show();
            });
        });
    </script>

    {% block scripts %}{% endblock %}

</body>

</html>
