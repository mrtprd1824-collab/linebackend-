{% extends "base.html" %}
{% set page_type = 'chat' %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat-modern.css') }}">
    <style>
        @media (min-width: 992px) {
            body.page-chat {
                overflow: hidden;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="chat-container">

    <div class="user-list-panel">
        <div class="user-list-header">
            <a href="/chats/" class="text-decoration-none">
                <h4>üí¨ Conversations</h4>
            </a>
            {% if pagination.page > 1 %}
            <span class="badge bg-secondary fw-normal">Page {{ pagination.page }}</span>
            {% endif %}
        </div>

        <div id="new-message-alert" class="new-message-alert">
            New messages arrived. Click to view.
        </div>

        <div class="chat-search-bar p-3 border-bottom">
            <div class="input-group input-group-sm chat-search-input">
                <input type="text" id="user-search-input" class="form-control form-control-sm"
                    placeholder="Search by Nickname, Phone, User ID...">
                <button class="btn btn-outline-secondary btn-sm" type="button" id="user-search-btn">Search</button>
            </div>
        </div>

        <div class="chat-status-bar p-3 border-bottom">
            <div class="btn-group btn-group-sm w-100" role="group">

                <input type="radio" class="btn-check" name="statusFilterRadio" id="statusAll" value="all"
                    autocomplete="off" {% if status_filter=='all' %}checked{% endif %}>
                <label class="btn btn-outline-primary flex-fill" for="statusAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>

                <input type="radio" class="btn-check" name="statusFilterRadio" id="statusDeposit" value="deposit"
                    autocomplete="off" {% if status_filter=='deposit' %}checked{% endif %}>
                <label class="btn btn-outline-success flex-fill" for="statusDeposit">‡∏ù‡∏≤‡∏Å</label>

                <input type="radio" class="btn-check" name="statusFilterRadio" id="statusWithdraw" value="withdraw"
                    autocomplete="off" {% if status_filter=='withdraw' %}checked{% endif %}>
                <label class="btn btn-outline-warning flex-fill" for="statusWithdraw">‡∏ñ‡∏≠‡∏ô</label>

                <input type="radio" class="btn-check" name="statusFilterRadio" id="statusIssue" value="issue"
                    autocomplete="off" {% if status_filter=='issue' %}checked{% endif %}>
                <label class="btn btn-outline-danger flex-fill" for="statusIssue">‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label>

            </div>
        </div>

        <ul class="list-group user-list-items" id="user-list">
            {% for conv in conversations %}
            {% set msg = conv.message %}
            {% set user = conv.user %}
            <a href="#"
                class="list-group-item list-group-item-action d-flex align-items-center status-{{ user.status }}"
                data-userid="{{ msg.user_id }}" data-oaid="{{ msg.line_account_id }}" {# --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ --- #} {%
                if conv.last_unread_timestamp %} data-unread-timestamp="{{ conv.last_unread_timestamp }}" {% endif %}>

                <img src="{{ user.picture_url or url_for('static', filename='images/No_profile.png') }}" alt="Profile"
                    class="rounded-circle me-3" style="width: 50px; height: 50px;">

                <div class="flex-grow-1">
                    {% set display_name = conv.user.nickname or conv.user.display_name %}
                    <div class="d-flex w-100 justify-content-between">
                        <strong class="mb-1">{{ display_name|truncate(20, True, '...') }}</strong>
                        <div>
                            <small class="text-danger me-2 unread-timer"
                                id="timer-{{ conv.user.user_id }}-{{ conv.user.line_account_id }}"></small>
                            {% if conv.unread_count > 0 %}
                            <span class="badge bg-danger rounded-pill">{{ conv.unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted me-2">@{{ conv.message.line_account.name }}</small>
                            {% for tag in conv.tags %}
                            <span class="badge me-1"
                                style="background-color: {{ tag.color }}; color: white; font-size: 0.65em;">{{
                                tag.name }}</span>
                            {% endfor %}
                        </div>
                        <small class="text-muted" data-iso-timestamp="{{ conv.last_message_iso_timestamp }}"></small>
                    </div>

                    <p class="mb-0 text-muted small sidebar-last-message">
                        <span class="message-preview">
                            {% if conv.message.is_outgoing %}
                            <span>‡∏Ñ‡∏∏‡∏ì:</span>
                            {% else %}
                            <span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span>
                            {% endif %}

                            {% if conv.message.message_type == 'text' %}
                            {{ conv.message.message_text | truncate(10) }}
                            {% elif conv.message.message_type == 'event' %}
                            {{ conv.message.message_text | truncate(10) }}
                            {% else %}
                            [{{ conv.message.message_type | capitalize }}]
                            {% endif %}
                        </span>

                        {% if conv.read_by %}
                        <small class="text-muted read-by-badge">{{ conv.read_by }}</small>
                        {% endif %}
                    </p>
                </div>
            </a>
            {% endfor %}
        </ul>
        <div class="p-3 text-center border-top" id="sidebar-pagination-container">
            {% if pagination.has_next %}
            <a href="{{ url_for('chats.index', page=pagination.next_num, status_filter=status_filter) }}"
                class="btn btn-outline-primary btn-sm">
                Load More Conversations
            </a>
            {% endif %}
        </div>
    </div>

    <div class="chat-window-panel" id="chat-window">
        <div class="chat-placeholder">
            <i class="bi bi-chat-dots-fill" style="font-size: 5rem;"></i>
            <h3 class="mt-3">Select a conversation</h3>
            <p class="text-muted">Choose a user from the list on the left to view their messages.</p>
        </div>

        <div id="chat-area" class="d-none">
            <div class="chat-header" id="chat-header">
                <div class="chat-header-left">
                    <h5 class="mb-1 fw-semibold d-flex align-items-center gap-2">
                        <i class="bi bi-person-circle text-primary"></i>
                        <span id="chat-user-name">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                    </h5>
                    <div id="user-tags-container" class="chat-tag-list"></div>
                </div>
                <div class="chat-header-right">
                    <a href="#" id="chatting-on-link" class="chat-oa-link disabled">
                        <span class="text-muted small">OA:</span>
                        <span class="fw-semibold" id="chatting-on-name">-</span>
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="manage-tags-btn">
                        <i class="bi bi-tags-fill"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Tag
                    </button>
                </div>
            </div>
            <div class="chat-messages" id="chat-messages">
            </div>
            <div class="chat-input">
                <form id="reply-form" class="d-flex align-items-center w-100">
                    <div id="inline-qr-results" class="list-group"
                        style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; z-index: 1000; margin-bottom: 5px; max-height: 250px; overflow-y: auto; border-radius: 0.375rem; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
                    </div>
                    <input type="file" id="image-input" accept="image/png, image/jpeg" style="display: none;">

                    <button type="button" class="btn btn-secondary me-2" id="attach-image-btn" title="Send Image"><i
                            class="bi bi-paperclip"></i></button>
                    <button type="button" class="btn btn-secondary me-2" id="sticker-btn" data-bs-toggle="modal"
                        data-bs-target="#stickerPickerModal" title="Send Sticker"><i
                            class="bi bi-emoji-smile"></i></button>
                    <button type="button" class="btn btn-info" id="quick-reply-btn" data-bs-toggle="modal"
                        data-bs-target="#quickReplyModal" title="Quick Reply"><i
                            class="bi bi-lightning-fill"></i></button>

                    <textarea class="form-control" id="reply-message" rows="1"
                        placeholder="Type your message..."></textarea>
                    <button type="submit" class="btn btn-primary" id="send-btn">Send</button>
                </form>
                <div id="blocked-user-alert" class="alert alert-secondary text-center m-0 d-none" role="alert">
                    ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó, ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE
                    ‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>
        </div>
    </div>

    <div class="customer-info-panel" id="customer-info-panel">
        <div class="info-placeholder text-center text-muted p-4">
            <i class="bi bi-person-lines-fill" style="font-size: 4rem;"></i>
            <p class="mt-2">Customer details will appear here.</p>
        </div>

        <div id="info-area" class="d-none">
        </div>
    </div>

    </div>

    <div class="modal fade" id="quickReplyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Replies</h5>
                    <input type="text" class="form-control ms-3" id="quick-reply-search" placeholder="Search...">
                </div>
                <div class="modal-body" id="quick-reply-list" style="max-height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imagePreviewModalLabel">Send this image?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="preview-image" src="#" class="img-fluid" alt="Image preview">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-send-image-btn">Send Image</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <img src="" id="full-image-view" class="img-fluid">
            </div>
        </div>
    </div>

    <div class="modal fade" id="stickerPickerModal" tabindex="-1" aria-labelledby="stickerPickerModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stickerPickerModalLabel">Select Sticker</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="sticker-grid" class="sticker-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;">
                        <p>Loading stickers...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="noteEditorModal" tabindex="-1" aria-labelledby="noteEditorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteEditorModalLabel">Edit Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea id="full-note-textarea" class="form-control" rows="10"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="save-note-btn" class="btn btn-primary">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tagsModal" tabindex="-1" aria-labelledby="tagsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tagsModalLabel">Manage Tags for User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Tag ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</p>
                    <div id="tags-checklist-container">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-tags-btn">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}

<script id="server-data" type="application/json">{{ server_data | safe }}</script>
<script src="{{ url_for('static', filename='js/chat-ui.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/chat-api.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/main.js') }}" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏° Radio ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
        const statusRadios = document.querySelectorAll('input[name="statusFilterRadio"]');

        // 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°
        statusRadios.forEach(function (radio) {
            radio.addEventListener('change', function () {
                // 3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
                const selectedValue = this.value;
                // 4. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á URL ‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö filter ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                window.location.href = `/chats/?status_filter=${selectedValue}`;
            });
        });
        function initialTimestampFormatting() {
            const timeElements = document.querySelectorAll('[data-iso-timestamp]');
            timeElements.forEach(el => {
                const isoString = el.dataset.isoTimestamp;
                if (isoString) {
                    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á main.js ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß
                    el.textContent = formatSidebarTimestamp(isoString);
                }
            });
        }
        initialTimestampFormatting();
    });
</script>

{% endblock %}
