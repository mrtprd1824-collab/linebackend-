{% extends "base.html" %}

{% block title %}Search Customers{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4"><i class="bi bi-search me-2"></i>Search Customers</h2>

    <div class="card card-body mb-4">
        <form id="search-form">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="search-query" class="form-label">Search Term</label>
                    <input type="text" class="form-control" id="search-query" placeholder="Name, Phone, User ID...">
                </div>
                <div class="col-md-4">
                    <label for="search-oa" class="form-label">Filter by Line OA</label>
                    <select class="form-select" id="search-oa">
                        <option value="">All OAs</option>
                        {% for oa in all_line_accounts %}
                        <option value="{{ oa.id }}">{{ oa.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Filter by Tags</label>
                    <div id="tags-checkbox-container" class="bg-light p-2 border rounded"
                        style="max-height: 100px; overflow-y: auto;">
                        <p class="text-muted small m-0">Loading tags...</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="search-start-date" class="form-label">Last Contact (Start Date)</label>
                    <input type="date" class="form-control" id="search-start-date">
                </div>
                <div class="col-md-6">
                    <label for="search-end-date" class="form-label">Last Contact (End Date)</label>
                    <input type="date" class="form-control" id="search-end-date">
                </div>
            </div>
            <div class="mt-3 border-top pt-3 text-end">
                <button type="reset" class="btn btn-secondary">Clear</button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel-fill me-2"></i>Search</button>
                <button type="button" id="export-btn" class="btn btn-outline-success">
                    <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>Export
                </button>
            </div>
        </form>
    </div>

    <h3 class="mb-3">Results</h3>
    <div id="search-results-container" class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Tag</th>
                    <th>Name/Nickname</th>
                    <th>Phone</th>
                    <th>User ID</th>
                    <th>Line OA</th>
                    <th>Last Seen (Bangkok)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="results-tbody">
                <tr>
                    <td colspan="6" class="text-center text-muted">Please enter search criteria and press "Search".</td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav id="pagination-container" aria-label="Page navigation"></nav>
</div>

<div class="modal fade" id="quick-send-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-send-fill me-2"></i>Send Quick Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">
                    To: <strong id="quick-send-recipient"></strong>
                </p>
                <textarea id="quick-send-textarea" class="form-control" rows="5"
                    placeholder="Type your message..."></textarea>
                <div id="quick-send-status" class="mt-2 small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="quick-send-btn">Send Message</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Element Selectors ---
        const tagsContainer = document.getElementById('tags-checkbox-container');
        const searchForm = document.getElementById('search-form');
        const resultsTbody = document.getElementById('results-tbody');
        const paginationContainer = document.getElementById('pagination-container');

        // --- 1. Populate Tags Filter ---
        async function populateTagsFilter() {
            try {
                const response = await fetch('/api/tags');
                if (!response.ok) throw new Error('Could not fetch tags');
                const tags = await response.json();

                tagsContainer.innerHTML = '';
                if (tags.length === 0) {
                    tagsContainer.innerHTML = '<p class="text-muted small m-0">No tags created.</p>';
                    return;
                }

                tags.forEach(tag => {
                    const div = document.createElement('div');
                    div.className = 'form-check form-check-inline';
                    div.innerHTML = `
                    <input class="form-check-input" type="checkbox" name="tags" value="${tag.id}" id="tag-check-${tag.id}">
                    <label class="form-check-label" for="tag-check-${tag.id}">
                        <span class="badge" style="background-color: ${tag.color}; color: #fff;">${tag.name}</span>
                    </label>
                `;
                    tagsContainer.appendChild(div);
                });
            } catch (error) {
                console.error("Failed to load tags for filter:", error);
                tagsContainer.innerHTML = '<span class="text-danger small">Could not load tags.</span>';
            }
        }

        // --- 2. Handle Search Submission ---
        async function performSearch(page = 1) {
            const query = document.getElementById('search-query').value;
            const selectedTags = Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(cb => cb.value);
            const startDate = document.getElementById('search-start-date').value;
            const endDate = document.getElementById('search-end-date').value;
            const oaId = document.getElementById('search-oa').value;

            const params = new URLSearchParams();
            params.append('page', page);
            if (query) params.append('q', query);
            if (selectedTags.length > 0) params.append('tags', selectedTags.join(','));
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (oaId) params.append('oa_id', oaId);

            const apiUrl = `/api/search/users?${params.toString()}`;

            resultsTbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div></td></tr>';
            paginationContainer.innerHTML = '';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Search request failed');
                const data = await response.json();

                renderSearchResults(data.users);
                renderPagination(data.pagination);
            } catch (error) {
                console.error("Search failed:", error);
                resultsTbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">An error occurred.</td></tr>';
            }
        }

        searchForm.addEventListener('submit', function (event) {
            event.preventDefault();
            performSearch(1);
        });

        // --- 3. Render Search Results ---
        function renderSearchResults(users) {
            resultsTbody.innerHTML = '';
            if (users.length === 0) {
                resultsTbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users found.</td></tr>';
                return;
            }

            users.forEach(user => {
                const tagsHtml = user.tags.map(tag =>
                    `<span class="badge rounded-pill me-1" style="background-color: ${tag.color}; color: #fff;">${tag.name}</span>`
                ).join(' ');

                const row = document.createElement('tr');

                row.innerHTML = `
                <td>${tagsHtml || '-'}</td>
                <td>${user.nickname || user.display_name || 'Unknown'}</td>
                <td>${user.phone || '-'}</td>
                
                <td><small class="text-muted">${user.user_id}</small></td>

                <td>${user.line_oa_name}</td>
                <td>${user.last_seen_at}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary open-quick-send-modal" 
                            data-bs-toggle="modal" 
                            data-bs-target="#quick-send-modal"
                            data-userid="${user.user_id}" 
                            data-oaid="${user.line_account_id}"
                            data-displayname="${user.nickname || user.display_name}">
                        <i class="bi bi-send"></i> Send
                    </button>
                </td>
                `;
                resultsTbody.appendChild(row);
            });
        }

        // --- 4. Pagination Functions ---
        function renderPagination(pagination) {
            paginationContainer.innerHTML = '';
            if (!pagination || pagination.total_pages <= 1) return;

            const ul = document.createElement('ul');
            ul.className = 'pagination justify-content-center';

            const currentPage = pagination.current_page;
            const totalPages = pagination.total_pages;

            const createPageLink = (page, text, isDisabled = false, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${page}">${text}</a>`;
                return li;
            };

            ul.appendChild(createPageLink(currentPage - 1, 'Previous', !pagination.has_prev));

            const window = 2;
            let start = Math.max(2, currentPage - window);
            let end = Math.min(totalPages - 1, currentPage + window);

            ul.appendChild(createPageLink(1, '1', false, currentPage === 1));
            if (start > 2) {
                ul.appendChild(createPageLink(0, '...', true));
            }

            for (let i = start; i <= end; i++) {
                ul.appendChild(createPageLink(i, i, false, currentPage === i));
            }

            if (end < totalPages - 1) {
                ul.appendChild(createPageLink(0, '...', true));
            }
            if (totalPages > 1) {
                ul.appendChild(createPageLink(totalPages, totalPages, false, currentPage === totalPages));
            }

            ul.appendChild(createPageLink(currentPage + 1, 'Next', !pagination.has_next));

            paginationContainer.appendChild(ul);
        }

        // ★★★ ส่วนนี้คือส่วนสำคัญที่เพิ่มเข้ามา ★★★
        // Event Listener สำหรับดักฟังการคลิกที่ปุ่ม Pagination
        paginationContainer.addEventListener('click', function (event) {
            event.preventDefault(); // หยุดการทำงานปกติของลิงก์
            const link = event.target.closest('.page-link'); // หาลิงก์ที่ถูกคลิก

            // ตรวจสอบว่าลิงก์นั้นใช้งานได้ (ไม่ใช่ปุ่ม disabled)
            if (link && !link.closest('.disabled')) {
                const page = parseInt(link.dataset.page); // ดึงหมายเลขหน้า
                performSearch(page); // เรียกใช้ฟังก์ชันค้นหาสำหรับหน้าใหม่
            }
        });

        // --- A. โค้ดสำหรับส่งข้อมูล User ไปให้ Modal ตอนที่กำลังจะเปิด ---
        const quickSendModal = document.getElementById('quick-send-modal');
        quickSendModal.addEventListener('show.bs.modal', function (event) {
            // ดึงปุ่มที่ถูกคลิก
            const button = event.relatedTarget;

            // ดึงข้อมูลจาก data-* attributes ของปุ่ม
            const userId = button.dataset.userid;
            const oaId = button.dataset.oaid;
            const displayName = button.dataset.displayname;

            // นำข้อมูลไปใส่ใน Modal
            const modalRecipient = quickSendModal.querySelector('#quick-send-recipient');
            modalRecipient.textContent = displayName;

            // เก็บ ID ไว้กับปุ่ม Send ใน Modal เพื่อใช้ตอนส่งข้อความ
            const sendBtn = quickSendModal.querySelector('#quick-send-btn');
            sendBtn.dataset.userid = userId;
            sendBtn.dataset.oaid = oaId;

            // เคลียร์ข้อความเก่าและสถานะ
            quickSendModal.querySelector('#quick-send-textarea').value = '';
            quickSendModal.querySelector('#quick-send-status').innerHTML = '';
            sendBtn.disabled = false;
        });

        // --- B. โค้ดสำหรับจัดการการกดปุ่ม "Send Message" ใน Modal ---
        const sendBtn = document.getElementById('quick-send-btn');
        sendBtn.addEventListener('click', async function () {
            const userId = sendBtn.dataset.userid;
            const oaId = sendBtn.dataset.oaid;
            const messageText = document.getElementById('quick-send-textarea').value.trim();
            const statusDiv = document.getElementById('quick-send-status');

            if (!messageText) {
                statusDiv.innerHTML = '<span class="text-danger">Please enter a message.</span>';
                return;
            }

            sendBtn.disabled = true; // ปิดปุ่มกันการกดซ้ำ
            statusDiv.innerHTML = '<span class="text-muted">Sending...</span>';

            try {
                // ใช้ API Endpoint สำหรับส่งข้อความที่คุณมีอยู่แล้ว
                const response = await fetch('/chats/api/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        oa_id: oaId,
                        message: messageText
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send message.');
                }

                statusDiv.innerHTML = '<span class="text-success">Message sent successfully!</span>';

                // หน่วงเวลาเล็กน้อยแล้วปิด Modal
                setTimeout(() => {
                    bootstrap.Modal.getInstance(quickSendModal).hide();
                }, 1200);

            } catch (error) {
                console.error("Quick send failed:", error);
                statusDiv.innerHTML = '<span class="text-danger">Error: Could not send message.</span>';
                sendBtn.disabled = false; // เปิดปุ่มให้ลองใหม่
            }
        });

        // --- Initial Load ---
        populateTagsFilter();
    });
</script>
{% endblock %}