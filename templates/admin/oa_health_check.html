{% extends "base.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/oa-health.css') }}">
{% endblock %}

{% block content %}
<div id="oa-health-page" class="container py-4 py-lg-5">
    <section class="oa-hero p-4 p-lg-5 mb-5 rounded-4">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-4">
            <div>
                <span class="oa-label text-uppercase fw-semibold">System Monitor</span>
                <h1 class="display-6 fw-semibold mb-2">OA Health Check</h1>
                <p class="mb-0 text-muted">ตรวจสอบสถานะการเชื่อมต่อของ Line OA ทุกบัญชี หากพบปัญหาให้ดำเนินการทันที</p>
            </div>
            <button id="run-check-btn" class="btn btn-primary oa-run-btn">
                <i class="bi bi-arrow-clockwise me-2"></i> ตรวจสอบทั้งหมด
            </button>
        </div>
        <p id="status-text" class="text-muted small mt-3 ms-1">กดปุ่มเพื่อเริ่มการตรวจสอบ</p>
    </section>

    <section class="card oa-card border-0 shadow-sm rounded-4">
        <div class="card-body p-0">
            <table class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th scope="col">สถานะ</th>
                        <th scope="col">ชื่อ OA</th>
                        <th scope="col" class="text-end">ตรวจครั้งล่าสุด</th>
                        <th scope="col">รายละเอียด</th>
                    </tr>
                </thead>
                <tbody id="oa-table-body">
                    {% for acc in accounts %}
                    <tr id="oa-row-{{ acc.id }}">
                        <td id="status-cell-{{ acc.id }}">
                            {% if acc.is_active %}
                            <span class="badge oa-status oa-status--up">
                                <i class="bi bi-check-circle me-1"></i> Active
                            </span>
                            {% else %}
                            <span class="badge oa-status oa-status--down">
                                <i class="bi bi-exclamation-triangle me-1"></i> Inactive
                            </span>
                            {% endif %}
                        </td>
                        <td class="fw-semibold">{{ acc.name }}</td>
                        <td id="last-check-{{ acc.id }}" class="text-end text-muted">
                            {% if acc.last_check_timestamp %}
                            {{ (acc.last_check_timestamp + timedelta(hours=7)).strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                            ไม่เคยตรวจ
                            {% endif %}
                        </td>
                        <td id="details-cell-{{ acc.id }}" class="small text-muted">
                            {{ acc.last_check_status_message or 'ยังไม่มีข้อมูล' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.getElementById('run-check-btn').addEventListener('click', function () {
        const btn = this;
        const statusText = document.getElementById('status-text');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
        statusText.textContent = 'Checking in progress, this may take a moment...';
        statusText.className = 'text-primary';

        // ใช้ fetch เพื่อเรียก API Endpoint
        fetch("{{ url_for('admin.run_oa_check_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    // ถ้ามี Error ให้ไปที่ .catch
                    return response.json().then(err => { throw new Error(err.message || 'Server Error') });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'completed') {
                    statusText.textContent = 'Check completed! Reloading page to see the latest status...';
                    statusText.className = 'text-success';

                    // เมื่อทำงานเสร็จ ให้ Reload หน้าเว็บ
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000); // รอ 1 วินาทีก่อน Reload
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.textContent = 'An error occurred during the check: ' + error.message;
                statusText.className = 'text-danger';

                // คืนค่าปุ่มให้เป็นปกติเมื่อเกิด Error
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Run Check on All OAs';
            });
    });
</script>
{% endblock %}
