{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>OA Health Check Status</h1>
        <button id="run-check-btn" class="btn btn-primary">
            <i class="bi bi-arrow-clockwise"></i> Run Check on All OAs
        </button>
    </div>
    <p id="status-text" class="text-muted">Click the button to start checking all OAs...</p>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>Status</th>
                <th>OA Name</th>
                <th>Last Check</th>
                <th>Details</th> <!-- *** รวมเป็นคอลัมน์เดียว *** -->
            </tr>
        </thead>
        <tbody id="oa-table-body">
            {% for acc in accounts %}
            <tr id="oa-row-{{ acc.id }}">
                <td id="status-cell-{{ acc.id }}">
                    {% if acc.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ acc.name }}</td>
                <td id="last-check-{{ acc.id }}">
                    {% if acc.last_check_timestamp %}
                    {{ (acc.last_check_timestamp + timedelta(hours=7)).strftime('%Y-%m-%d %H:%M:%S') }}
                    {% else %}
                    Never
                    {% endif %}
                </td>
                <!-- *** แสดงผลจาก last_check_status_message ที่เดียว *** -->
                <td id="details-cell-{{ acc.id }}" class="small text-muted">{{ acc.last_check_status_message }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.getElementById('run-check-btn').addEventListener('click', function () {
        const btn = this;
        const statusText = document.getElementById('status-text');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
        statusText.textContent = 'Checking in progress, this may take a moment...';
        statusText.className = 'text-primary';

        // ใช้ fetch เพื่อเรียก API Endpoint
        fetch("{{ url_for('admin.run_oa_check_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    // ถ้ามี Error ให้ไปที่ .catch
                    return response.json().then(err => { throw new Error(err.message || 'Server Error') });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'completed') {
                    statusText.textContent = 'Check completed! Reloading page to see the latest status...';
                    statusText.className = 'text-success';

                    // เมื่อทำงานเสร็จ ให้ Reload หน้าเว็บ
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000); // รอ 1 วินาทีก่อน Reload
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.textContent = 'An error occurred during the check: ' + error.message;
                statusText.className = 'text-danger';

                // คืนค่าปุ่มให้เป็นปกติเมื่อเกิด Error
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Run Check on All OAs';
            });
    });
</script>
{% endblock %}