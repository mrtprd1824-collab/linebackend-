{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>OA Health Check Status</h1>
        <button id="run-check-btn" class="btn btn-primary">
            <i class="bi bi-arrow-clockwise"></i> Run Check on All OAs
        </button>
    </div>
    <p id="status-text" class="text-muted">Click the button to start checking all OAs...</p>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>Status</th>
                <th>OA Name</th>
                <th>Last Check</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="oa-table-body">
            {% for acc in accounts %}
            <tr id="oa-row-{{ acc.id }}">
                <td>
                    {% if acc.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ acc.name }}</td>
                <td>
                    {% if acc.last_check_timestamp %}
                    {# บวกเวลาเพิ่ม 7 ชั่วโมง แล้วจัดรูปแบบการแสดงผล #}
                    {{ (acc.last_check_timestamp + timedelta(hours=7)).strftime('%Y-%m-%d %H:%M:%S') }}
                    {% else %}
                    Never
                    {% endif %}
                </td>
                <td class="small text-muted">{{ acc.last_check_status_message }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.getElementById('run-check-btn').addEventListener('click', function () {
        const btn = this;
        const statusText = document.getElementById('status-text');

        // Disable button and show loading text
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
        statusText.textContent = 'Checking in progress, please wait...';
        statusText.className = 'text-primary';

        fetch("{{ url_for('admin.run_oa_check_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log('Check completed:', data);
                statusText.textContent = 'Check completed! Reloading page to see latest status...';
                statusText.className = 'text-success';

                // Reload the page to show the updated status from the database
                setTimeout(function () {
                    window.location.reload();
                }, 1500); // Wait 1.5 seconds before reloading
            })
            .catch(error => {
                console.error('Error:', error);
                statusText.textContent = 'An error occurred during the check.';
                statusText.className = 'text-danger';
                // Re-enable button on error
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Run Check on All OAs';
            });
    });
</script>
{% endblock %}