{% extends "base.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/line-accounts.css') }}">
{% endblock %}

{% block content %}
<div id="line-accounts-page" class="container py-4 py-lg-5">
  <section class="la-hero p-4 p-lg-5 mb-5 rounded-4">
    <div class="d-flex flex-column flex-xl-row align-items-xl-center justify-content-xl-between gap-4">
      <div>
        <span class="la-label text-uppercase fw-semibold">Line OA</span>
        <h1 class="display-6 fw-semibold mb-2">
          จัดการบัญชี Line Official Account
        </h1>
        <p class="mb-0 text-muted">
          เพิ่ม แก้ไข หรือจัดกลุ่ม OA ให้พร้อมใช้งานกับเว็บฮุกของคุณในไม่กี่ขั้นตอน
        </p>
      </div>
      <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 w-100 w-xl-auto">
        <form id="filter-form" method="get" action="{{ url_for('line_admin.line_admin_index') }}" class="la-filter-form">
          <select name="group_filter" class="form-select la-select" onchange="this.form.submit();">
            <option value="">เลือกกรุ๊ปทั้งหมด</option>
            {% for group in groups %}
            <option value="{{ group.id }}" {% if group.id == selected_group_id %}selected{% endif %}>
              {{ group.name }}
            </option>
            {% endfor %}
          </select>
        </form>
        <button type="button" class="btn btn-primary la-add-btn" data-bs-toggle="modal" data-bs-target="#addAccountModal">
          <i class="bi bi-plus-circle-fill me-2"></i> เพิ่ม OA ใหม่
        </button>
      </div>
    </div>
  </section>

  <section class="card la-table-card border-0 shadow-sm rounded-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table align-middle mb-0 la-table">
          <thead>
            <tr>
              <th scope="col">ชื่อ OA</th>
              <th scope="col">กลุ่มที่อยู่</th>
              <th scope="col">Webhook URL</th>
              <th scope="col" class="text-end">การจัดการ</th>
            </tr>
          </thead>
          <tbody>
            {% for account in accounts %}
            <tr>
              <td>
                <div class="d-flex flex-column">
                  <span class="fw-semibold">{{ account.name }}</span>
                  <small class="text-muted">ID: {{ account.id }}</small>
                </div>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-2">
                  {% for group in account.groups %}
                  <span class="badge la-chip">{{ group.name }}</span>
                  {% else %}
                  <span class="text-muted small">ยังไม่ได้ระบุ</span>
                  {% endfor %}
                </div>
              </td>
              <td>
                <div class="input-group input-group-sm la-input-group">
                  <input type="text"
                         class="form-control"
                         value="{{ base_url.rstrip('/') }}{{ url_for('line_webhook.callback', webhook_path=account.webhook_path) }}"
                         id="webhook-url-{{ account.id }}"
                         readonly>
                  <button class="btn btn-outline-secondary la-copy-btn"
                          type="button"
                          onclick="copyToClipboard('webhook-url-{{ account.id }}', this)">
                    <i class="bi bi-clipboard"></i>
                  </button>
                </div>
              </td>
              <td class="text-end">
                <div class="btn-group la-action-group">
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#editAccountModal{{ account.id }}">
                    <i class="bi bi-pencil-fill me-1"></i> แก้ไข
                  </button>
                  <form method="post"
                        action="{{ url_for('line_admin.delete_line_account', id=account.id) }}"
                        onsubmit="return confirm('ต้องการลบ OA นี้หรือไม่?');"
                        class="d-inline">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      <i class="bi bi-trash-fill me-1"></i> ลบ
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" class="text-center text-muted py-5">
                ไม่พบบัญชี OA
                {% if selected_group_id %}
                <a href="{{ url_for('line_admin.line_admin_index') }}" class="d-block mt-2">ล้างตัวกรอง</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

{# --- MODALS --- #}

<!-- Modal: Add -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAccountModalLabel">Add New LINE Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('line_admin.add_line_account') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label for="nameAdd" class="form-label">Account Name</label>
              <input type="text" class="form-control" id="nameAdd" name="name" required>
            </div>
            <div class="col-md-6">
              <label for="channel_idAdd" class="form-label">Channel ID</label>
              <input type="text" class="form-control" id="channel_idAdd" name="channel_id" required>
            </div>
            <div class="col-md-6">
              <label for="channel_secretAdd" class="form-label">Channel Secret</label>
              <input type="text" class="form-control" id="channel_secretAdd" name="channel_secret" required>
            </div>
            <div class="col-12">
              <label for="channel_access_tokenAdd" class="form-label">Channel Access Token</label>
              <textarea class="form-control" id="channel_access_tokenAdd" name="channel_access_token" rows="3"
                required></textarea>
            </div>
            <div class="col-12">
              <label for="manager_urlAdd" class="form-label">Manager URL (Optional)</label>
              <input type="url" class="form-control" id="manager_urlAdd" name="manager_url"
                placeholder="https://manager.line.biz/account/...">
            </div>
            <div class="col-12">
              <label class="form-label">Groups</label>
              <div class="d-flex flex-wrap gap-2">
                {% for group in groups %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="groups" value="{{ group.id }}"
                    id="groupAdd{{ group.id }}">
                  <label class="form-check-label" for="groupAdd{{ group.id }}">{{ group.name }}</label>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modals: Edit (Loop) -->
{% for account in accounts %}
<div class="modal fade" id="editAccountModal{{ account.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit LINE Account: {{ account.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('line_admin.edit_line_account', id=account.id) }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label for="nameEdit{{ account.id }}" class="form-label">Account Name</label>
              <input type="text" class="form-control" id="nameEdit{{ account.id }}" name="name"
                value="{{ account.name }}" required>
            </div>
            <div class="col-md-6">
              <label for="channel_idEdit{{ account.id }}" class="form-label">Channel ID</label>
              <input type="text" class="form-control" id="channel_idEdit{{ account.id }}" name="channel_id"
                value="{{ account.channel_id }}" required>
            </div>
            <div class="col-md-6">
              <label for="channel_secretEdit{{ account.id }}" class="form-label">Channel Secret</label>
              <input type="text" class="form-control" id="channel_secretEdit{{ account.id }}" name="channel_secret"
                value="{{ account.channel_secret }}" required>
            </div>
            <div class="col-12">
              <label for="channel_access_tokenEdit{{ account.id }}" class="form-label">Channel Access Token</label>
              <textarea class="form-control" id="channel_access_tokenEdit{{ account.id }}" name="channel_access_token"
                rows="3" placeholder="Leave blank to keep current token"></textarea>
              <small class="text-muted">ปล่อยว่างไว้ถ้าไม่ต้องการเปลี่ยน Token</small>
            </div>
            <div class="col-12">
              <label for="manager_urlEdit{{ account.id }}" class="form-label">Manager URL (Optional)</label>
              <input type="url" class="form-control" id="manager_urlEdit{{ account.id }}" name="manager_url"
                value="{{ account.manager_url or '' }}" placeholder="https://manager.line.biz/account/...">
            </div>
            <div class="col-12">
              <label class="form-label">Groups</label>
              <div class="d-flex flex-wrap gap-2">
                {% for group in groups %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="groups" value="{{ group.id }}"
                    id="groupEdit{{ account.id }}-{{ group.id }}" {% if group in account.groups %}checked{% endif %}>
                  <label class="form-check-label" for="groupEdit{{ account.id }}-{{ group.id }}">{{ group.name
                    }}</label>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<script>
  function copyToClipboard(elementId, buttonElement) {
    const el = document.getElementById(elementId);
    el.select();
    el.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(el.value);

    // --- [ส่วนแก้ไข] ---
    const originalIconHTML = buttonElement.innerHTML;

    // 1. สลับ Class จาก outline เป็น solid
    buttonElement.classList.remove('btn-outline-secondary');
    buttonElement.classList.add('btn-success');
    buttonElement.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';

    // 2. เปลี่ยนกลับหลังจาก 2 วินาที
    setTimeout(() => {
      buttonElement.innerHTML = originalIconHTML;
      buttonElement.classList.remove('btn-success');
      buttonElement.classList.add('btn-outline-secondary');
    }, 2000);
  }
</script>
{% endblock %}
