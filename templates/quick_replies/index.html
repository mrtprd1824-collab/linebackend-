{% extends "base.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quick-replies.css') }}">
{% endblock %}

{% block content %}
<div id="quick-replies-page" class="container py-4 py-lg-5">
    <section class="qr-hero p-4 p-lg-5 mb-5 rounded-4 shadow-sm">
        <div class="d-flex flex-column flex-xl-row align-items-xl-center justify-content-xl-between gap-4">
            <div>
                <span class="qr-label text-uppercase fw-semibold">Quick Replies</span>
                <h1 class="display-6 fw-semibold mb-2">
                    <i class="bi bi-lightning-charge-fill me-2"></i>จัดการข้อความตอบกลับเร็ว
                </h1>
                <p class="mb-0 text-muted">
                    เลือก Line OA แล้วปรับข้อความ Shortcut ได้ทันทีแบบไม่ต้องโหลดหน้าใหม่
                </p>
            </div>
            <div class="text-muted small">
                <div><i class="bi bi-lightbulb-fill me-1"></i> เพิ่ม, แก้ไข, ลบ ได้จากช่องเดียว</div>
                <div><i class="bi bi-link-45deg me-1"></i> Quick reply ทั่วไป (Global) จะแสดงทุก OA</div>
            </div>
        </div>
    </section>

    <div class="row g-4 qr-layout">
        <div class="col-12 col-lg-4">
            <aside class="qr-oa-panel p-4 rounded-4 shadow-sm h-100">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h2 class="h5 fw-semibold mb-0">Line OA ทั้งหมด</h2>
                    <span class="badge bg-primary-subtle text-primary-emphasis">
                        {{ account_options|length }}
                    </span>
                </div>
                <div class="qr-oa-list" id="qr-oa-list">
                    <button type="button"
                            class="qr-oa-item btn w-100 text-start {% if selected_oa_id is none %}active{% endif %}"
                            data-oa-key="global">
                        <span class="qr-oa-name">Global (ทุก OA)</span>
                        <small class="text-muted d-block">Shortcut ที่ใช้ร่วมกันทุกบัญชี</small>
                    </button>
                    {% for account in account_options %}
                    <button type="button"
                            class="qr-oa-item btn w-100 text-start {% if selected_oa_id is not none and account.id == selected_oa_id %}active{% endif %}"
                            data-oa-key="{{ account.id }}">
                        <span class="qr-oa-name">{{ account.name }}</span>
                        <small class="text-muted d-block">ดูและแก้ไขของ OA นี้</small>
                    </button>
                    {% endfor %}
                </div>
            </aside>
        </div>

        <div class="col-12 col-lg-8">
            <section class="qr-workspace d-flex flex-column gap-4 h-100">
                <div id="qr-feedback" class="alert d-none" role="alert"></div>

                <div class="qr-card p-4 rounded-4 shadow-sm">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
                        <div>
                            <h2 class="h5 fw-semibold mb-1">เพิ่ม Quick Reply ใหม่</h2>
                            <p class="text-muted small mb-0">กรอก Shortcut และข้อความ แล้วเลือกว่าจะใช้กับ OA ไหน</p>
                        </div>
                    </div>
                    <form id="new-reply-form" class="row g-3">
                        <input type="hidden" name="csrf_token" value="{{ add_form.csrf_token._value() }}">
                        <div class="col-md-4">
                            <label for="new-shortcut" class="form-label">Shortcut</label>
                            <input type="text" class="form-control" id="new-shortcut" name="shortcut" maxlength="50" required>
                        </div>
                        <div class="col-md-8">
                            <label for="new-message" class="form-label">Message</label>
                            <textarea class="form-control" id="new-message" name="message" rows="2" required></textarea>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label for="new-line-account" class="form-label">ใช้งานกับ</label>
                            <select class="form-select" id="new-line-account" name="line_account">
                                <option value="__None">Global (ทุก OA)</option>
                                {% for account in account_options %}
                                <option value="{{ account.id }}">{{ account.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-4 ms-md-auto d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-circle me-2"></i>บันทึก Quick Reply
                            </button>
                        </div>
                    </form>
                </div>

                <div class="qr-card p-4 rounded-4 shadow-sm flex-grow-1">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
                        <div>
                            <h2 class="h5 fw-semibold mb-1" id="qr-list-title">รายการ Quick Replies</h2>
                            <p class="text-muted small mb-0" id="qr-list-subtitle">
                                เลือก OA ที่ต้องการจากคอลัมน์ซ้ายเพื่อดูรายการ
                            </p>
                        </div>
                        <span class="badge bg-secondary-subtle text-secondary-emphasis" id="qr-count-badge">0 รายการ</span>
                    </div>
                    <div id="qr-empty-state" class="qr-empty-state text-center text-muted py-5 d-none">
                        <i class="bi bi-inboxes display-5 d-block mb-3"></i>
                        <p class="mb-0">ยังไม่มี Quick Reply ใน OA นี้</p>
                    </div>
                    <div id="qr-replies-container" class="qr-reply-list d-flex flex-column gap-3"></div>
                </div>
            </section>
        </div>
    </div>
</div>

<script>
    window.quickRepliesConfig = {
        csrfToken: {{ add_form.csrf_token._value()|tojson }},
        selectedAccountId: {{ (selected_oa_id if selected_oa_id is not none else None)|tojson }},
        accounts: {{ account_options|tojson }},
        routes: {
            data: {{ url_for('quick_replies.data')|tojson }},
            add: {{ url_for('quick_replies.add')|tojson }},
            edit: {{ (url_for('quick_replies.edit', id=0)[:-1])|tojson }},
            delete: {{ (url_for('quick_replies.delete', id=0)[:-1])|tojson }}
        }
    };
</script>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/quick-replies.js') }}"></script>
{% endblock %}
