{% extends "base.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quick-replies.css') }}">
{% endblock %}

{% block content %}
<div id="quick-replies-page" class="container py-4 py-lg-5">
    <section class="qr-hero p-4 p-lg-5 mb-5 rounded-4">
        <div class="d-flex flex-column flex-xl-row align-items-xl-center justify-content-xl-between gap-4">
            <div>
                <span class="qr-label text-uppercase fw-semibold">Quick Replies</span>
                <h1 class="display-6 fw-semibold mb-2"><i class="bi bi-lightning-charge-fill me-2"></i>จัดการข้อความตอบกลับเร็ว</h1>
                <p class="mb-0 text-muted">สร้างแม่แบบข้อความเพื่อสนทนากับลูกค้าได้ทันใจ รองรับทั้ง Global และเฉพาะ OA</p>
            </div>
            <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 w-100 w-xl-auto">
                <form id="filter-form" method="get" action="{{ url_for('quick_replies.index') }}" class="qr-filter">
                    <select name="oa_filter" class="form-select qr-select" onchange="document.getElementById('filter-form').submit();">
                        <option value="">ทั้งหมด</option>
                        {% for account in all_accounts %}
                        <option value="{{ account.id }}" {% if account.id == selected_oa_id %}selected{% endif %}>
                            {{ account.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
                <button type="button" class="btn btn-primary qr-add-btn" data-bs-toggle="modal" data-bs-target="#addReplyModal">
                    <i class="bi bi-plus-circle-fill me-2"></i> เพิ่มข้อความใหม่
                </button>
            </div>
        </div>
    </section>

    <section class="card qr-table-card border-0 shadow-sm rounded-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0 qr-table">
                    <thead>
                        <tr>
                            <th scope="col">Shortcut</th>
                            <th scope="col">Message</th>
                            <th scope="col">Belongs to OA</th>
                            <th scope="col" class="text-end" style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reply in replies %}
                        <tr>
                            <td><code class="qr-shortcut">{{ reply.shortcut }}</code></td>
                            <td class="text-truncate" style="max-width: 420px;">{{ reply.message }}</td>
                            <td>
                                <span class="badge qr-badge {{ 'qr-badge--global' if not reply.line_account else '' }}">
                                    {{ reply.line_account.name if reply.line_account else 'Global' }}
                                </span>
                            </td>
                            <td class="text-end">
                                <div class="btn-group qr-actions">
                                    <button type="button" class="btn btn-outline-secondary btn-sm edit-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editReplyModal"
                                            data-id="{{ reply.id }}"
                                            data-shortcut="{{ reply.shortcut }}"
                                            data-message="{{ reply.message }}"
                                            data-oa-id="{{ reply.line_account_id or '' }}">
                                        <i class="bi bi-pencil-fill me-1"></i> แก้ไข
                                    </button>

                                    <form method="post" action="{{ url_for('quick_replies.delete', id=reply.id) }}"
                                        onsubmit="return confirm('ต้องการลบข้อความนี้หรือไม่?');" class="d-inline">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-trash-fill me-1"></i> ลบ
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-5">
                                ไม่พบข้อความตอบกลับ
                                {% if selected_oa_id %}
                                    <a href="{{ url_for('quick_replies.index') }}" class="d-block mt-2">ล้างตัวกรอง</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

{# --- MODALS (เหมือนเดิม แต่ผมเพิ่ม ID ให้ฟอร์ม Add เพื่อความชัดเจน) --- #}

<!-- Add Modal -->
<div class="modal fade" id="addReplyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Reply</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="add-form" method="POST" action="{{ url_for('quick_replies.add') }}">
        {{ add_form.hidden_tag() }}
        <div class="modal-body">
          <div class="mb-3">
            {{ add_form.shortcut.label(class="form-label") }}
            {{ add_form.shortcut(class="form-control", required=True) }}
          </div>
          <div class="mb-3">
            {{ add_form.message.label(class="form-label") }}
            {{ add_form.message(class="form-control", rows=4, required=True) }}
          </div>
          <div class="mb-3">
            {{ add_form.line_account.label(class="form-label") }}
            {{ add_form.line_account(class="form-select") }}
            <div class="form-text">เลือก -- Global -- หากต้องการให้ใช้ได้กับทุก OA</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {{ add_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit -->

<div class="modal fade" id="editReplyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Reply</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="edit-form" method="POST" action="">
          {{ edit_form.hidden_tag() }}
          <div class="modal-body">
            <div class="mb-3">
              {{ edit_form.shortcut.label(class="form-label") }}
              {{ edit_form.shortcut(class="form-control", id="edit_shortcut", required=True) }}
            </div>
            <div class="mb-3">
              {{ edit_form.message.label(class="form-label") }}
              {{ edit_form.message(class="form-control", rows=4, id="edit_message", required=True) }}
            </div>
            <div class="mb-3">
              {{ edit_form.line_account.label(class="form-label") }}
              {{ edit_form.line_account(class="form-select", id="edit_line_account") }}
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            {{ edit_form.submit(class="btn btn-primary", value="Update") }}
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editReplyModal = document.getElementById('editReplyModal');
        const editForm = document.getElementById('edit-form');
        const editShortcut = document.getElementById('edit_shortcut');
        const editMessage = document.getElementById('edit_message');
        const editLineAccount = document.getElementById('edit_line_account');

        // เมื่อ Modal กำลังจะแสดง
        editReplyModal.addEventListener('show.bs.modal', function (event) {
            // ปุ่มที่ถูกคลิก
            const button = event.relatedTarget;

            // ดึงข้อมูลจาก data-* attributes ของปุ่ม
            const id = button.dataset.id;
            const shortcut = button.dataset.shortcut;
            const message = button.dataset.message;
            const oaId = button.dataset.oaId;

            // สร้าง URL ที่ถูกต้องสำหรับ action ของฟอร์ม
            const actionUrl = `/quick-replies/edit/${id}`;
            
            // อัปเดตค่าในฟอร์มของ Modal
            editForm.action = actionUrl;
            editShortcut.value = shortcut;
            editMessage.value = message;
            editLineAccount.value = oaId;
        });
    });
</script>

{% endblock %}
